{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../services/src/config/index.ts"],"names":[],"mappings":";AAAA,0CAA0C;AAC1C,2DAA2D;;AAE3D,qDAA+C;AAI/C,0BAAsC;AAEtC;;GAEG;AACH,IAAI,kBAAkB,GAAG,YAAY,CAAC;AA2BtC;;GAEG;AACH,IAAiB,aAAa,CA6B7B;AA7BD,WAAiB,aAAa;IAC5B;;;;OAIG;IACH,gBACE,OAA+B;QAE/B,IAAI,OAAO,GAAG,IAAI,oBAAoB,CAAC,OAAO,CAAC,CAAC;QAChD,OAAO,OAAO,CAAC,IAAI,EAAE,CAAC,IAAI,CAAC,GAAG,EAAE;YAC9B,OAAO,OAAO,CAAC;QACjB,CAAC,CAAC,CAAC;IACL,CAAC;IAPe,oBAAM,SAOrB,CAAA;AAgBH,CAAC,EA7BgB,aAAa,GAAb,qBAAa,KAAb,qBAAa,QA6B7B;AAED;;GAEG;AACH;IACE;;OAEG;IACH,YAAY,OAA+B;QA0EnC,SAAI,GAAG,SAAS,CAAC;QAzEvB,IAAI,QAAQ,GAAG,CAAC,IAAI,CAAC,cAAc;YACjC,OAAO,CAAC,cAAc,IAAI,oBAAgB,CAAC,YAAY,EAAE,CAAC,CAAC;QAC7D,IAAI,CAAC,IAAI,GAAG,kBAAM,CAAC,IAAI,CACrB,QAAQ,CAAC,OAAO,EAChB,kBAAkB,EAClB,kBAAkB,CAAC,OAAO,CAAC,IAAI,CAAC,CACjC,CAAC;IACJ,CAAC;IAOD;;OAEG;IACH,IAAI,IAAI;QACN,OAAO,IAAI,CAAC,KAAK,CAAC;IACpB,CAAC;IAED;;;;;;;OAOG;IACH,IAAI;QACF,OAAO,oBAAgB,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,EAAE,EAAE,EAAE,IAAI,CAAC,cAAc,CAAC;aACpE,IAAI,CAAC,QAAQ,CAAC,EAAE;YACf,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,EAAE;gBAC3B,MAAM,IAAI,oBAAgB,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;aACpD;YACD,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;QACzB,CAAC,CAAC;aACD,IAAI,CAAC,IAAI,CAAC,EAAE;YACX,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QACpB,CAAC,CAAC,CAAC;IACP,CAAC;IAED;;;;;;;;;;;OAWG;IACH,MAAM,CAAC,OAAmB;QACxB,IAAI,CAAC,KAAK,qBAAQ,IAAI,CAAC,KAAK,EAAK,OAAO,CAAE,CAAC;QAC3C,IAAI,IAAI,GAAG;YACT,MAAM,EAAE,OAAO;YACf,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC;SAC9B,CAAC;QACF,OAAO,oBAAgB,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,cAAc,CAAC;aACtE,IAAI,CAAC,QAAQ,CAAC,EAAE;YACf,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,EAAE;gBAC3B,MAAM,IAAI,oBAAgB,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;aACpD;YACD,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;QACzB,CAAC,CAAC;aACD,IAAI,CAAC,IAAI,CAAC,EAAE;YACX,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;YAClB,OAAO,IAAI,CAAC,KAAK,CAAC;QACpB,CAAC,CAAC,CAAC;IACP,CAAC;CAIF;AAED;;GAEG;AACH;IACE;;OAEG;IACH,YAAY,OAAoC;QAqDxC,eAAU,GAAG,EAAE,CAAC;QApDtB,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC,OAAO,CAAC;QAChC,IAAI,CAAC,SAAS,GAAG,OAAO,CAAC,QAAQ,IAAI,EAAE,CAAC;QACxC,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,SAAS,IAAI,EAAE,CAAC;IAC5C,CAAC;IAED;;OAEG;IACH,GAAG,CAAC,GAAW;QACb,IAAI,IAAI,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC;QAC7B,OAAO,GAAG,IAAI,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;IACvD,CAAC;IAED;;;;;;;;;;OAUG;IACH,GAAG,CAAC,GAAW,EAAE,KAAgB;QAC/B,IAAI,CAAC,GAAe,EAAE,CAAC;QACvB,CAAC,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;QACf,IAAI,IAAI,CAAC,UAAU,EAAE;YACnB,IAAI,EAAE,GAAe,EAAE,CAAC;YACxB,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;YACxB,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;SACjC;aAAM;YACL,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;SAChC;IACH,CAAC;IAED;;;;;OAKG;IACK,UAAU;QAChB,IAAI,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;QAC9B,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,EAAE;YAC9C,OAAO,IAAI,CAAC,IAAI,CAAC,UAAU,CAAe,CAAC;SAC5C;QACD,OAAO,IAAI,CAAC;IACd,CAAC;CAKF;AA1DD,gDA0DC","sourcesContent":["// Copyright (c) Jupyter Development Team.\n// Distributed under the terms of the Modified BSD License.\n\nimport { URLExt } from '@jupyterlab/coreutils';\n\nimport { JSONObject, JSONValue } from '@phosphor/coreutils';\n\nimport { ServerConnection } from '..';\n\n/**\n * The url for the config service.\n */\nlet SERVICE_CONFIG_URL = 'api/config';\n\n/**\n * A Configurable data section.\n */\nexport interface IConfigSection {\n  /**\n   * The data for this section.\n   */\n  readonly data: JSONObject;\n\n  /**\n   * Modify the stored config values.\n   *\n   * #### Notes\n   * Updates the local data immediately, sends the change to the server,\n   * and updates the local data with the response, and fulfils the promise\n   * with that data.\n   */\n  update(newdata: JSONObject): Promise<JSONObject>;\n\n  /**\n   * The server settings for the section.\n   */\n  readonly serverSettings: ServerConnection.ISettings;\n}\n\n/**\n * The namespace for ConfigSection statics.\n */\nexport namespace ConfigSection {\n  /**\n   * Create a config section.\n   *\n   * @returns A Promise that is fulfilled with the config section is loaded.\n   */\n  export function create(\n    options: ConfigSection.IOptions\n  ): Promise<IConfigSection> {\n    let section = new DefaultConfigSection(options);\n    return section.load().then(() => {\n      return section;\n    });\n  }\n\n  /**\n   * The options used to create a config section.\n   */\n  export interface IOptions {\n    /**\n     * The section name.\n     */\n    name: string;\n\n    /**\n     * The optional server settings.\n     */\n    serverSettings?: ServerConnection.ISettings;\n  }\n}\n\n/**\n * Implementation of the Configurable data section.\n */\nclass DefaultConfigSection implements IConfigSection {\n  /**\n   * Construct a new config section.\n   */\n  constructor(options: ConfigSection.IOptions) {\n    let settings = (this.serverSettings =\n      options.serverSettings || ServerConnection.makeSettings());\n    this._url = URLExt.join(\n      settings.baseUrl,\n      SERVICE_CONFIG_URL,\n      encodeURIComponent(options.name)\n    );\n  }\n\n  /**\n   * The server settings for the section.\n   */\n  readonly serverSettings: ServerConnection.ISettings;\n\n  /**\n   * Get the data for this section.\n   */\n  get data(): JSONObject {\n    return this._data;\n  }\n\n  /**\n   * Load the initial data for this section.\n   *\n   * #### Notes\n   * Uses the [Jupyter Notebook API](http://petstore.swagger.io/?url=https://raw.githubusercontent.com/jupyter/notebook/master/notebook/services/api/api.yaml#!/config).\n   *\n   * The promise is fulfilled on a valid response and rejected otherwise.\n   */\n  load(): Promise<void> {\n    return ServerConnection.makeRequest(this._url, {}, this.serverSettings)\n      .then(response => {\n        if (response.status !== 200) {\n          throw new ServerConnection.ResponseError(response);\n        }\n        return response.json();\n      })\n      .then(data => {\n        this._data = data;\n      });\n  }\n\n  /**\n   * Modify the stored config values.\n   *\n   * #### Notes\n   * Uses the [Jupyter Notebook API](http://petstore.swagger.io/?url=https://raw.githubusercontent.com/jupyter/notebook/master/notebook/services/api/api.yaml#!/config).\n   *\n   * The promise is fulfilled on a valid response and rejected otherwise.\n   *\n   * Updates the local data immediately, sends the change to the server,\n   * and updates the local data with the response, and fulfils the promise\n   * with that data.\n   */\n  update(newdata: JSONObject): Promise<JSONObject> {\n    this._data = { ...this._data, ...newdata };\n    let init = {\n      method: 'PATCH',\n      body: JSON.stringify(newdata)\n    };\n    return ServerConnection.makeRequest(this._url, init, this.serverSettings)\n      .then(response => {\n        if (response.status !== 200) {\n          throw new ServerConnection.ResponseError(response);\n        }\n        return response.json();\n      })\n      .then(data => {\n        this._data = data;\n        return this._data;\n      });\n  }\n\n  private _url = 'unknown';\n  private _data: JSONObject;\n}\n\n/**\n * Configurable object with defaults.\n */\nexport class ConfigWithDefaults {\n  /**\n   * Create a new config with defaults.\n   */\n  constructor(options: ConfigWithDefaults.IOptions) {\n    this._section = options.section;\n    this._defaults = options.defaults || {};\n    this._className = options.className || '';\n  }\n\n  /**\n   * Get data from the config section or fall back to defaults.\n   */\n  get(key: string): JSONValue {\n    let data = this._classData();\n    return key in data ? data[key] : this._defaults[key];\n  }\n\n  /**\n   * Set a config value.\n   *\n   * #### Notes\n   * Uses the [Jupyter Notebook API](http://petstore.swagger.io/?url=https://raw.githubusercontent.com/jupyter/notebook/master/notebook/services/api/api.yaml#!/config).\n   *\n   * The promise is fulfilled on a valid response and rejected otherwise.\n   *\n   * Sends the update to the server, and changes our local copy of the data\n   * immediately.\n   */\n  set(key: string, value: JSONValue): Promise<JSONValue> {\n    let d: JSONObject = {};\n    d[key] = value;\n    if (this._className) {\n      let d2: JSONObject = {};\n      d2[this._className] = d;\n      return this._section.update(d2);\n    } else {\n      return this._section.update(d);\n    }\n  }\n\n  /**\n   * Get data from the Section with our classname, if available.\n   *\n   * #### Notes\n   * If we have no classname, get all of the data in the Section\n   */\n  private _classData(): JSONObject {\n    let data = this._section.data;\n    if (this._className && this._className in data) {\n      return data[this._className] as JSONObject;\n    }\n    return data;\n  }\n\n  private _section: IConfigSection;\n  private _defaults: JSONObject;\n  private _className = '';\n}\n\n/**\n * A namespace for ConfigWithDefaults statics.\n */\nexport namespace ConfigWithDefaults {\n  /**\n   * The options used to initialize a ConfigWithDefaults object.\n   */\n  export interface IOptions {\n    /**\n     * The configuration section.\n     */\n    section: IConfigSection;\n\n    /**\n     * The default values.\n     */\n    defaults?: JSONObject;\n\n    /**\n     * The optional classname namespace.\n     */\n    className?: string;\n  }\n}\n"]}